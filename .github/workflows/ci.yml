name: End-to-end tests
on: 
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
jobs:
  cypress-run:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          command: npm run cy:report
      
      - name: Archive Mochawesome Report
        uses: actions/upload-artifact@v4
        with:
          name: mochawesome-report
          path: cypress/reports/mochawesome-report/mochawesome.html
          if-no-files-found: ignore
          
      - name: Debug Report Files
        run: ls -la cypress/reports cypress/reports/mochawesome-report || echo "Pasta não encontrada"
      
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          if-no-files-found: ignore
      
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-videos
          path: cypress/videos
          if-no-files-found: ignore
      
      - name: Create index.html for GitHub Pages
        if: always()
        run: |
          echo '<html><head><meta http-equiv="refresh" content="0; url=./mochawesome.html"></head><body><p>Redirecting to Mochawesome report...</p></body></html>' > cypress/reports/mochawesome-report/index.html
          ls -la cypress/reports/mochawesome-report
          cat cypress/reports/mochawesome-report/index.html
          ls -la cypress/reports/mochawesome-report/mochawesome.html || echo "mochawesome.html não encontrado"
      
      - name: Deploy Mochawesome Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./cypress/reports/mochawesome-report
          destination_dir: .
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          force_orphan: true
        env:
          DEBUG: actions-gh-pages