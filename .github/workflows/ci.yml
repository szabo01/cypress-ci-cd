name: End-to-end tests
on: 
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
jobs:
  cypress-run:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: docker build -t cypress-ci-cd .
      
      - name: Run Cypress in Docker
        run: docker run --rm -v $(pwd):/app cypress-ci-cd npm run cy:report
      
      - name: Debug Report Files
        run: ls -la cypress/reports cypress/reports/mochawesome-report || echo "Pasta não encontrada"
      
      - name: Upload Cypress Artifacts on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            cypress/screenshots
            cypress/videos
          if-no-files-found: ignore
      
      - name: Create index.html for GitHub Pages
        if: always()
        run: |
          mkdir -p cypress/reports/mochawesome-report/reports/${{ github.run_id }}
          mv cypress/reports/mochawesome-report/mochawesome.html cypress/reports/mochawesome-report/reports/${{ github.run_id }}/mochawesome.html
          echo '<html><head><title>Cypress Test Reports</title><style>body { font-family: Arial, sans-serif; text-align: center; padding: 50px; } a { color: #007bff; text-decoration: none; } a:hover { text-decoration: underline; }</style></head><body><h1>Cypress Test Reports</h1><ul><li><a href="reports/${{ github.run_id }}/mochawesome.html">Report ${{ github.run_id }}</a></li></ul></body></html>' > cypress/reports/mochawesome-report/index.html
          ls -la cypress/reports/mochawesome-report
          cat cypress/reports/mochawesome-report/index.html
          ls -la cypress/reports/mochawesome-report/reports/${{ github.run_id }} || echo "mochawesome.html não encontrado"
      
      - name: Deploy Mochawesome Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./cypress/reports/mochawesome-report
          destination_dir: .
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          force_orphan: false
          keep_files: true
        env:
          DEBUG: actions-gh-pages